using Microsoft.EntityFrameworkCore;
using takip.Data;
using takip.Models;
using takip.Services;

namespace takip.Services
{
    /// <summary>
    /// Mixer2 Status-Based Batch Processor - √áoklu Batch Sistemi
    /// </summary>
    public class Mixer2StatusBasedProcessor
    {
        private readonly ProductionDbContext _context;
        private readonly ConcreteBatch2Service _batchService;
        private readonly CementConsumptionService _cementConsumptionService;
        
        public static event Action<string>? OnFlowEvent;
        
        // Debug log i√ßin event
        public static event Action<string>? OnDebugLogEvent;

        // Edge detection i√ßin √∂nceki durumlar
        private bool _prevYatayKova = false;
        private bool _prevDikeyKova = false;
        private bool _prevBeklemeBunker = false;
        private bool _prevMixerAgrega = false;
        private bool _prevMixerCimento = false;
        private bool _prevMixerLoadcellSu = false;
        private bool _prevMixerKatki = false;
        private bool _prevMixerPulseSu = false;
        private bool _prevKatkiGrupAktif = false;
        private bool _prevHarcHazir = false;
        
        
        // Katkƒ± tartƒ±m OK edge detection i√ßin √∂nceki durumlar
        private bool _prevKatki1TartimOk = false;
        private bool _prevKatki2TartimOk = false;
        private bool _prevKatki3TartimOk = false;
        private bool _prevKatki4TartimOk = false;
        private bool _prevKatki1SuTartimOk = false;
        private bool _prevKatki2SuTartimOk = false;
        private bool _prevKatki3SuTartimOk = false;
        private bool _prevKatki4SuTartimOk = false;
        
        // Pigment edge detection i√ßin √∂nceki durumlar
        private bool _prevMixerPigmentGrup = false;
        private bool _prevMixerPigment1 = false;
        
        // √áimento kaydƒ± i√ßin bekleyen batch ID'leri
        private HashSet<int> _waitingForCementBatchIds = new HashSet<int>();
        
        // √áimento kaydƒ± yapƒ±lan batch ID'leri (tekrar kayƒ±t yapƒ±lmasƒ±n diye)
        private HashSet<int> _cementRecordedBatchIds = new HashSet<int>();
        
        // √áimento kayƒ±t zamanlarƒ± (2 saniye bekleme i√ßin)
        private Dictionary<int, DateTime> _cementRecordTimes = new Dictionary<int, DateTime>();
        
        // Katkƒ± kaydƒ± i√ßin bekleyen batch ID'leri
        private HashSet<int> _waitingForAdmixtureBatchIds = new HashSet<int>();
        
        // Katkƒ± kaydƒ± yapƒ±lan batch ID'leri (tekrar kayƒ±t yapƒ±lmasƒ±n diye)
        private HashSet<int> _admixtureRecordedBatchIds = new HashSet<int>();
        
        // Katkƒ± kayƒ±t zamanlarƒ± (2 saniye bekleme i√ßin)
        private Dictionary<int, DateTime> _admixtureRecordTimes = new Dictionary<int, DateTime>();
        
        // √áimento edge detection i√ßin √∂nceki durumlar
        private bool _prevCimento1Active = false;
        private bool _prevCimento2Active = false;
        private bool _prevCimento3Active = false;
        private bool _prevMixerPigment2 = false;
        private bool _prevMixerPigment3 = false;
        private bool _prevMixerPigment4 = false;

        // Anlƒ±k durumlar (UI i√ßin)
        public bool CurrentYatayKova { get; private set; }
        public bool CurrentDikeyKova { get; private set; }
        public bool CurrentBeklemeBunker { get; private set; }
        public bool CurrentMixerAgrega { get; private set; }
        public bool CurrentMixerCimento { get; private set; }
        public bool CurrentMixerLoadcellSu { get; private set; }
        public bool CurrentMixerKatki { get; private set; }
        public bool CurrentMixerPulseSu { get; private set; }
        public bool CurrentHarcHazir { get; private set; }

        public Mixer2StatusBasedProcessor(ProductionDbContext context, ConcreteBatch2Service batchService, CementConsumptionService cementConsumptionService)
        {
            _context = context;
            _batchService = batchService;
            _cementConsumptionService = cementConsumptionService;
        }

        /// <summary>
        /// State'i ba≈üka processor'dan kopyala (edge detection i√ßin)
        /// </summary>
        public void CopyStateFrom(Mixer2StatusBasedProcessor other)
        {
            _prevYatayKova = other._prevYatayKova;
            _prevDikeyKova = other._prevDikeyKova;
            _prevBeklemeBunker = other._prevBeklemeBunker;
            _prevMixerAgrega = other._prevMixerAgrega;
            _prevMixerCimento = other._prevMixerCimento;
            _prevMixerLoadcellSu = other._prevMixerLoadcellSu;
            _prevMixerKatki = other._prevMixerKatki;
            _prevMixerPulseSu = other._prevMixerPulseSu;
            _prevKatkiGrupAktif = other._prevKatkiGrupAktif;
            _prevHarcHazir = other._prevHarcHazir;
            
            // Katkƒ± tartƒ±m OK edge detection
            _prevKatki1TartimOk = other._prevKatki1TartimOk;
            _prevKatki2TartimOk = other._prevKatki2TartimOk;
            _prevKatki3TartimOk = other._prevKatki3TartimOk;
            _prevKatki4TartimOk = other._prevKatki4TartimOk;
            _prevKatki1SuTartimOk = other._prevKatki1SuTartimOk;
            _prevKatki2SuTartimOk = other._prevKatki2SuTartimOk;
            _prevKatki3SuTartimOk = other._prevKatki3SuTartimOk;
            _prevKatki4SuTartimOk = other._prevKatki4SuTartimOk;
            _prevMixerPigmentGrup = other._prevMixerPigmentGrup;
            _prevMixerPigment1 = other._prevMixerPigment1;
            _prevMixerPigment2 = other._prevMixerPigment2;
            _prevMixerPigment3 = other._prevMixerPigment3;
            _prevMixerPigment4 = other._prevMixerPigment4;
        }

        /// <summary>
        /// PLC snapshot'ƒ±nƒ± i≈üle - Mixer2 √ßoklu batch sistemi
        /// </summary>
        public async Task ProcessPlcSnapshotAsync(PlcDataSnapshot snapshot, string operatorName)
        {
            try
            {
                // 1. Yatay kova sinyali kontrol√º - Yeni batch olu≈ütur
                await CheckYatayKovaSignal(snapshot, operatorName);

                // 2. Dikey kova sinyali kontrol√º - Status ge√ßi≈üi
                await CheckDikeyKovaSignal(snapshot);

                // 3. Bekleme bunker sinyali kontrol√º - Status ge√ßi≈üi
                await CheckBeklemeBunkerSignal(snapshot);

                // 4. Mixer agrega sinyali kontrol√º - Status ge√ßi≈üi
                await CheckMixerAgregaSignal(snapshot);

                // 5. Mixer i√ßerik sinyalleri - Veri kaydetme
                var mixerBatches = await GetBatchesByStatus("Mixerde");
                OnFlowEvent?.Invoke($"üîç Mixer Debug - Mixerde batch sayƒ±sƒ±: {mixerBatches.Count}");
                
                await CheckMixerCimentoSignal(snapshot);
                await CheckMixerLoadcellSuSignal(snapshot);
                await CheckMixerKatkiSignal(snapshot);
                await CheckMixerPulseSuSignal(snapshot);
                await CheckMixerPigmentSignal(snapshot); // ‚úÖ Pigment kayƒ±t eklendi

                // 6. Har√ß hazƒ±r sinyali - Batch tamamlama
                await CheckHarcHazirSignal(snapshot);
            }
            catch (Exception ex)
            {
                OnFlowEvent?.Invoke($"‚ùå {LocalizationService.Instance.GetString("Mixer2StatusBasedProcessor.ProcessingError")}: {ex.Message}");
            }
        }

        /// <summary>
        /// Yatay kova sinyali kontrol√º - Yeni batch olu≈ütur
        /// </summary>
        private async Task CheckYatayKovaSignal(PlcDataSnapshot snapshot, string operatorName)
        {
            var yatayKova = GetBitValue(snapshot, "YatayKovadaMalzemeVar");
            CurrentYatayKova = yatayKova;

            // Rising edge: Yeni batch olu≈ütur
            if (yatayKova && !_prevYatayKova)
            {
                await CreateNewBatch(snapshot, operatorName);
                OnFlowEvent?.Invoke($"üü¢ {LocalizationService.Instance.GetString("Mixer2StatusBasedProcessor.HorizontalBucketNewBatch")}");
            }

            // _prevYatayKova'yƒ± burada g√ºncelleme - CheckDikeyKovaSignal'de g√ºncellenecek
        }

        /// <summary>
        /// Dikey kova sinyali kontrol√º - Status ge√ßi≈üi
        /// </summary>
        private async Task CheckDikeyKovaSignal(PlcDataSnapshot snapshot)
        {
            var dikeyKova = GetBitValue(snapshot, "DikeyKovadaMalzemeVar");
            CurrentDikeyKova = dikeyKova;

            // Debug log - Dikey kova durumu
            OnFlowEvent?.Invoke($"üîç Dikey Kova Debug - DikeyKova: {dikeyKova}");

            // Yatay kova sinyali pasif olduƒüunda dikey kovaya ta≈üƒ± (falling edge)
            var yatayKova = GetBitValue(snapshot, "YatayKovadaMalzemeVar");
            
            // Debug log
            OnFlowEvent?.Invoke($"üîç Stat√ºs Debug - YatayKova: {yatayKova}, PrevYatayKova: {_prevYatayKova}");
            
            if (!yatayKova && _prevYatayKova) // Yatay kova pasif oldu
            {
                await UpdateBatchStatus("Yatay Kovada", "Dikey Kovada");
                OnFlowEvent?.Invoke($"üì¶ Yatay kova bo≈üaldƒ± - Batch'ler dikey kovaya ta≈üƒ±ndƒ±");
            }

            _prevYatayKova = yatayKova; // Yatay kova durumunu burada g√ºncelle
        }

        /// <summary>
        /// Bekleme bunker sinyali kontrol√º - Status ge√ßi≈üi
        /// </summary>
        private async Task CheckBeklemeBunkerSignal(PlcDataSnapshot snapshot)
        {
            var beklemeBunker = GetBitValue(snapshot, "BeklemeBunkerindeMalzemeVar");
            CurrentBeklemeBunker = beklemeBunker;

            // Dikey kova sinyali pasif olduƒüunda bekleme bunkerine ta≈üƒ± (falling edge)
            var dikeyKova = GetBitValue(snapshot, "DikeyKovadaMalzemeVar");
            
            // Debug log
            OnFlowEvent?.Invoke($"üîç Bekleme Debug - DikeyKova: {dikeyKova}, PrevDikeyKova: {_prevDikeyKova}");
            
            if (!dikeyKova && _prevDikeyKova) // Dikey kova pasif oldu
            {
                await UpdateBatchStatus("Dikey Kovada", "Bekleme Bunkerinde");
                OnFlowEvent?.Invoke($"üì¶ Dikey kova bo≈üaldƒ± - Batch'ler bekleme bunkerine ta≈üƒ±ndƒ±");
            }

            _prevDikeyKova = dikeyKova; // Dikey kova durumunu burada g√ºncelle
        }

        /// <summary>
        /// Mixer agrega sinyali kontrol√º - Status ge√ßi≈üi
        /// </summary>
        private async Task CheckMixerAgregaSignal(PlcDataSnapshot snapshot)
        {
            var mixerAgrega = GetBitValue(snapshot, "MixerdeAggregaVar");
            CurrentMixerAgrega = mixerAgrega;

            // Bekleme bunkeri sinyali pasif olduƒüunda mixere ta≈üƒ± (falling edge)
            var beklemeBunker = GetBitValue(snapshot, "BeklemeBunkerindeMalzemeVar");
            
            // Debug log
            OnFlowEvent?.Invoke($"üîç Mixer Debug - BeklemeBunker: {beklemeBunker}, PrevBeklemeBunker: {_prevBeklemeBunker}");
            
            if (!beklemeBunker && _prevBeklemeBunker) // Bekleme bunkeri pasif oldu
            {
                await UpdateBatchStatus("Bekleme Bunkerinde", "Mixerde");
                OnFlowEvent?.Invoke($"üè≠ Bekleme bunkeri bo≈üaldƒ± - Batch'ler mixere ta≈üƒ±ndƒ±");
            }

            _prevMixerAgrega = mixerAgrega;
            _prevBeklemeBunker = beklemeBunker; // Bekleme bunker durumunu burada g√ºncelle
        }

        /// <summary>
        /// Mixer √ßimento sinyali kontrol√º - Veri kaydetme
        /// </summary>
        private async Task CheckMixerCimentoSignal(PlcDataSnapshot snapshot)
        {
            // Mixerde batch kontrol√º
            var mixerBatches = await GetBatchesByStatus("Mixerde");
            
            // Yeni Mixerde batch'leri √ßimento bekleyen listesine ekle (sadece daha √∂nce kayƒ±t yapƒ±lmamƒ±≈ü olanlar)
            foreach (var batch in mixerBatches)
            {
                // 2 saniye bekleme kontrol√º
                bool canRecord = true;
                if (_cementRecordTimes.ContainsKey(batch.Id))
                {
                    var timeSinceLastRecord = DateTime.Now - _cementRecordTimes[batch.Id];
                    if (timeSinceLastRecord.TotalSeconds < 2)
                    {
                        canRecord = false;
                        OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batch.Id} 2 saniye bekleme s√ºresinde - kayƒ±t atlandƒ± (Kalan: {2 - timeSinceLastRecord.TotalSeconds:F1}s)");
                    }
                }
                
                if (!_waitingForCementBatchIds.Contains(batch.Id) && !_cementRecordedBatchIds.Contains(batch.Id) && canRecord)
                {
                    _waitingForCementBatchIds.Add(batch.Id);
                    OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batch.Id} √ßimento bekleyen listesine eklendi");
                }
                else if (!canRecord)
                {
                    // 2 saniye bekleme s√ºresinde - zaten log yazƒ±ldƒ±
                }
                else if (_cementRecordedBatchIds.Contains(batch.Id))
                {
                    OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batch.Id} zaten kayƒ±t edilmi≈ü - atlandƒ±");
                }
                else if (_waitingForCementBatchIds.Contains(batch.Id))
                {
                    OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batch.Id} zaten bekleyen - atlandƒ±");
                }
            }
            
            // Artƒ±k Mixerde olmayan batch'leri √ßimento bekleyen listesinden √ßƒ±kar
            var allBatchIds = mixerBatches.Select(b => b.Id).ToHashSet();
            var toRemove = _waitingForCementBatchIds.Where(id => !allBatchIds.Contains(id)).ToList();
            foreach (var id in toRemove)
            {
                _waitingForCementBatchIds.Remove(id);
                OnFlowEvent?.Invoke($"üß± DEBUG: Batch {id} √ßimento bekleyen listesinden √ßƒ±karƒ±ldƒ± (stat√ºs deƒüi≈üti)");
            }
            
            // Artƒ±k Mixerde olmayan batch'leri √ßimento kayƒ±t edilen listesinden de √ßƒ±kar
            var toRemoveFromRecorded = _cementRecordedBatchIds.Where(id => !allBatchIds.Contains(id)).ToList();
            foreach (var id in toRemoveFromRecorded)
            {
                _cementRecordedBatchIds.Remove(id);
                _cementRecordTimes.Remove(id);
                OnFlowEvent?.Invoke($"üß± DEBUG: Batch {id} √ßimento kayƒ±t edilen listesinden √ßƒ±karƒ±ldƒ± (stat√ºs deƒüi≈üti)");
            }

            if (mixerBatches.Count == 0) 
            {
                OnFlowEvent?.Invoke("üß± DEBUG: Mixerde batch bulunamadƒ± - √ßimento kayƒ±t atlandƒ±");
                return;
            }

            OnFlowEvent?.Invoke($"üß± DEBUG: Mixerde batch sayƒ±sƒ±: {mixerBatches.Count}, √áimento bekleyen: {_waitingForCementBatchIds.Count}");

            // √áimento bekleyen batch'ler varsa √ßimento kontrol√º yap
            if (_waitingForCementBatchIds.Count > 0)
            {
                // Her √ßimento i√ßin edge detection kontrol√º
                bool anyCimentoRisingEdge = false;
                for (int i = 1; i <= 3; i++)
                {
                    var aktif = GetBitValue(snapshot, $"M2_Cimento{i}Aktif");
                    var kg = GetWordValue(snapshot, $"M2_Cimento{i}Kg");
                    
                    OnFlowEvent?.Invoke($"üß± DEBUG: √áimento{i} - Aktif: {aktif}, Kg: {kg}");
                    
                    if (aktif && kg > 0)
                    {
                        // Edge detection: Aktif False ‚Üí True ge√ßi≈üi
                        bool prevAktif = i switch
                        {
                            1 => _prevCimento1Active,
                            2 => _prevCimento2Active,
                            3 => _prevCimento3Active,
                            _ => false
                        };
                        
                        if (!prevAktif) // Rising edge
                        {
                            anyCimentoRisingEdge = true;
                            OnFlowEvent?.Invoke($"üß± DEBUG: √áimento{i} aktif rising edge tespit edildi - kayƒ±t i≈ülemi ba≈ülatƒ±lƒ±yor");
                            break;
                        }
                    }
                }
                
                // Eƒüer bekleyen batch'ler zaten kayƒ±t edilmi≈üse, rising edge kontrol√ºn√º atla
                if (anyCimentoRisingEdge && _waitingForCementBatchIds.Any(id => _cementRecordedBatchIds.Contains(id)))
                {
                    OnFlowEvent?.Invoke($"üß± DEBUG: Bekleyen batch'ler zaten kayƒ±t edilmi≈ü - rising edge atlandƒ±");
                    anyCimentoRisingEdge = false;
                    
                    // Bekleyen batch'leri kayƒ±t edilen listesinden √ßƒ±kar
                    var alreadyRecorded = _waitingForCementBatchIds.Where(id => _cementRecordedBatchIds.Contains(id)).ToList();
                    foreach (var batchId in alreadyRecorded)
                    {
                        _waitingForCementBatchIds.Remove(batchId);
                        OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batchId} bekleyen listesinden √ßƒ±karƒ±ldƒ± (zaten kayƒ±t edilmi≈ü)");
                    }
                }

                // Eƒüer herhangi bir √ßimento rising edge ise kaydet
                if (anyCimentoRisingEdge)
                {
                    await RecordCementData(snapshot);
                    
                    // Kayƒ±t yapƒ±lan batch'leri kayƒ±t edilen listeye ekle ve zamanƒ± kaydet
                    var recordedBatchIds = _waitingForCementBatchIds.ToList();
                    foreach (var batchId in recordedBatchIds)
                    {
                        _cementRecordedBatchIds.Add(batchId);
                        _cementRecordTimes[batchId] = DateTime.Now; // Kayƒ±t zamanƒ±nƒ± kaydet
                        OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batchId} kayƒ±t edilen listeye eklendi ve zaman kaydedildi");
                    }
                    
                    // Sadece kayƒ±t yapƒ±lan batch'leri bekleyen listesinden √ßƒ±kar (t√ºm listeyi temizleme)
                    foreach (var batchId in recordedBatchIds)
                    {
                        _waitingForCementBatchIds.Remove(batchId);
                    }
                    OnFlowEvent?.Invoke($"üß± DEBUG: √áimento kaydedildi - kayƒ±t yapƒ±lan batch'ler bekleyen listesinden √ßƒ±karƒ±ldƒ±. Kayƒ±t edilen batch sayƒ±sƒ±: {_cementRecordedBatchIds.Count}");
                    
                    // SADECE KAYIT YAPILDIƒûINDA √∂nceki durumlarƒ± g√ºncelle
                    _prevCimento1Active = GetBitValue(snapshot, "M2_Cimento1Aktif");
                    _prevCimento2Active = GetBitValue(snapshot, "M2_Cimento2Aktif");
                    _prevCimento3Active = GetBitValue(snapshot, "M2_Cimento3Aktif");
                    OnFlowEvent?.Invoke($"üß± DEBUG: √áimento state'leri g√ºncellendi - C1: {_prevCimento1Active}, C2: {_prevCimento2Active}, C3: {_prevCimento3Active}");
                }
                else
                {
                    OnFlowEvent?.Invoke("üß± DEBUG: Hi√ßbir √ßimento rising edge deƒüil - beklemeye devam ediyor");
                }
            }
        }

        /// <summary>
        /// Mixer loadcell su sinyali kontrol√º - Veri kaydetme
        /// </summary>
        private async Task CheckMixerLoadcellSuSignal(PlcDataSnapshot snapshot)
        {
            var mixerLoadcellSu = GetBitValue(snapshot, "MixerdeLoadcellSuVar");
            CurrentMixerLoadcellSu = mixerLoadcellSu;

            // Rising edge: Mixerdeki batch'lere loadcell su verilerini kaydet
            if (mixerLoadcellSu && !_prevMixerLoadcellSu)
            {
                await RecordLoadcellWaterData(snapshot);
                OnFlowEvent?.Invoke("üíß Mixer loadcell su - Loadcell su verileri kaydedildi");
            }

            _prevMixerLoadcellSu = mixerLoadcellSu;
        }

        /// <summary>
        /// Mixer katkƒ± sinyali kontrol√º - Veri kaydetme
        /// </summary>
        /// <summary>
        /// Katkƒ± sinyallerini s√ºrekli g√ºncelle (batch status'u fark etmez)
        /// </summary>
        private void UpdateAdmixtureSignals(PlcDataSnapshot snapshot)
        {
            var admixtureDebugSb = new System.Text.StringBuilder();
            admixtureDebugSb.AppendLine("üß™ KATKI Sƒ∞NYALLERƒ∞");
            admixtureDebugSb.AppendLine("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
            
            // Katkƒ± grup aktif (H39.10)
            var katkiGrupAktif = GetBitValue(snapshot, "M2_KatkiGrupAktif");
            admixtureDebugSb.AppendLine($"üìä GRUP AKTƒ∞F (H39.10): {katkiGrupAktif}");
            admixtureDebugSb.AppendLine("");
            
            // Her katkƒ± i√ßin t√ºm register'larƒ± logla
            for (int i = 1; i <= 4; i++)
            {
                var aktif = GetBitValue(snapshot, $"M2_Katki{i}Aktif");
                var tartimOk = GetBitValue(snapshot, $"M2_Katki{i}TartimOk");
                var suTartimOk = GetBitValue(snapshot, $"M2_Katki{i}SuTartimOk");
                var kimyasalKg = GetWordValue(snapshot, $"M2_Katki{i}KimyasalKg");
                var suKg = GetWordValue(snapshot, $"M2_Katki{i}SuKg");

                admixtureDebugSb.AppendLine($"üß™ KATKI{i} (H3{i+8}.0):");
                admixtureDebugSb.AppendLine($"   ‚úÖ Aktif: {aktif}");
                admixtureDebugSb.AppendLine($"   ‚öñÔ∏è Tartƒ±m OK (H3{i+8}.3): {tartimOk}");
                admixtureDebugSb.AppendLine($"   üíß Su Tartƒ±m OK (H3{i+8}.4): {suTartimOk}");
                admixtureDebugSb.AppendLine($"   üß™ Kimyasal Kg (DM460{i*10+4}): {kimyasalKg:F2}");
                admixtureDebugSb.AppendLine($"   üíß Su Kg (DM460{i*10+5}): {suKg:F2}");
                admixtureDebugSb.AppendLine("");
            }
            
            OnDebugLogEvent?.Invoke(admixtureDebugSb.ToString());
        }

        /// <summary>
        /// Mixer katkƒ± sinyali kontrol√º - Katkƒ± verilerini kaydet
        /// </summary>
        private async Task CheckMixerKatkiSignal(PlcDataSnapshot snapshot)
        {
            // Katkƒ± sinyallerini s√ºrekli g√ºncelle
            UpdateAdmixtureSignals(snapshot);
            
            // Mixerde batch kontrol√º
            var mixerBatches = await GetBatchesByStatus("Mixerde");
            
            // Yeni Mixerde batch'leri katkƒ± bekleyen listesine ekle (sadece daha √∂nce kayƒ±t yapƒ±lmamƒ±≈ü olanlar)
            foreach (var batch in mixerBatches)
            {
                // 2 saniye bekleme kontrol√º
                bool canRecord = true;
                if (_admixtureRecordTimes.ContainsKey(batch.Id))
                {
                    var timeSinceLastRecord = DateTime.Now - _admixtureRecordTimes[batch.Id];
                    if (timeSinceLastRecord.TotalSeconds < 2)
                    {
                        canRecord = false;
                        OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {batch.Id} 2 saniye bekleme s√ºresinde - kayƒ±t atlandƒ± (Kalan: {2 - timeSinceLastRecord.TotalSeconds:F1}s)");
                    }
                }
                
                if (!_waitingForAdmixtureBatchIds.Contains(batch.Id) && !_admixtureRecordedBatchIds.Contains(batch.Id) && canRecord)
                {
                    _waitingForAdmixtureBatchIds.Add(batch.Id);
                    OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {batch.Id} katkƒ± bekleyen listesine eklendi");
                }
                else if (!canRecord)
                {
                    // 2 saniye bekleme s√ºresinde - zaten log yazƒ±ldƒ±
                }
                else if (_admixtureRecordedBatchIds.Contains(batch.Id))
                {
                    OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {batch.Id} zaten kayƒ±t edilmi≈ü - atlandƒ±");
                }
                else if (_waitingForAdmixtureBatchIds.Contains(batch.Id))
                {
                    OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {batch.Id} zaten bekleyen - atlandƒ±");
                }
            }
            
            // Artƒ±k Mixerde olmayan batch'leri katkƒ± bekleyen listesinden √ßƒ±kar
            var allBatchIds = mixerBatches.Select(b => b.Id).ToHashSet();
            var toRemove = _waitingForAdmixtureBatchIds.Where(id => !allBatchIds.Contains(id)).ToList();
            foreach (var id in toRemove)
            {
                _waitingForAdmixtureBatchIds.Remove(id);
                OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {id} katkƒ± bekleyen listesinden √ßƒ±karƒ±ldƒ± (stat√ºs deƒüi≈üti)");
            }
            
            // Artƒ±k Mixerde olmayan batch'leri katkƒ± kayƒ±t edilen listesinden de √ßƒ±kar
            var toRemoveFromRecorded = _admixtureRecordedBatchIds.Where(id => !allBatchIds.Contains(id)).ToList();
            foreach (var id in toRemoveFromRecorded)
            {
                _admixtureRecordedBatchIds.Remove(id);
                _admixtureRecordTimes.Remove(id);
                OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {id} katkƒ± kayƒ±t edilen listesinden √ßƒ±karƒ±ldƒ± (stat√ºs deƒüi≈üti)");
            }

            // Katkƒ± grup aktif kontrol√º
            var katkiGrupAktif = GetBitValue(snapshot, "M2_KatkiGrupAktif");
            if (!katkiGrupAktif) 
            {
                OnFlowEvent?.Invoke("üß™ DEBUG: Katkƒ± grup aktif deƒüil - kayƒ±t atlandƒ±");
                return;
            }

            // √áimento bekleyen batch'ler varsa katkƒ± kontrol√º yap
            if (_waitingForAdmixtureBatchIds.Count == 0)
            {
                OnFlowEvent?.Invoke("üß™ DEBUG: Katkƒ± bekleyen batch yok - kayƒ±t atlandƒ±");
                return;
            }

            // Her katkƒ± i√ßin tartƒ±m OK edge detection kontrol√º
            bool anyKatkiTartimOkRisingEdge = false;
            for (int i = 1; i <= 4; i++)
            {
                var aktif = GetBitValue(snapshot, $"M2_Katki{i}Aktif");
                var tartimOk = GetBitValue(snapshot, $"M2_Katki{i}TartimOk");
                var suTartimOk = GetBitValue(snapshot, $"M2_Katki{i}SuTartimOk");
                
                if (aktif && tartimOk && suTartimOk)
                {
                    // Edge detection: Hem kimyasal hem su tartƒ±m OK False ‚Üí True ge√ßi≈üi
                    bool prevTartimOk = i switch
                    {
                        1 => _prevKatki1TartimOk,
                        2 => _prevKatki2TartimOk,
                        3 => _prevKatki3TartimOk,
                        4 => _prevKatki4TartimOk,
                        _ => false
                    };
                    
                    bool prevSuTartimOk = i switch
                    {
                        1 => _prevKatki1SuTartimOk,
                        2 => _prevKatki2SuTartimOk,
                        3 => _prevKatki3SuTartimOk,
                        4 => _prevKatki4SuTartimOk,
                        _ => false
                    };
                    
                    if (!prevTartimOk || !prevSuTartimOk) // Rising edge
                    {
                        anyKatkiTartimOkRisingEdge = true;
                        OnFlowEvent?.Invoke($"üß™ DEBUG: Katkƒ±{i} tartƒ±m OK rising edge tespit edildi");
                        // break kaldƒ±rƒ±ldƒ± - t√ºm katkƒ±larƒ± kontrol et
                    }
                }
            }

            // Eƒüer herhangi bir katkƒ± tartƒ±m OK rising edge ise kaydet
            if (anyKatkiTartimOkRisingEdge)
            {
                OnFlowEvent?.Invoke("üß™ DEBUG: Katkƒ± tartƒ±m OK rising edge tespit edildi - kayƒ±t i≈ülemi ba≈ülatƒ±lƒ±yor");
                await RecordAdmixtureData(snapshot);
            }
            else
            {
                OnFlowEvent?.Invoke("üß™ DEBUG: Hi√ßbir katkƒ± tartƒ±m OK rising edge deƒüil - kayƒ±t atlandƒ±");
            }

            // √ñnceki durumlarƒ± g√ºncelle
            _prevKatki1TartimOk = GetBitValue(snapshot, "M2_Katki1TartimOk");
            _prevKatki2TartimOk = GetBitValue(snapshot, "M2_Katki2TartimOk");
            _prevKatki3TartimOk = GetBitValue(snapshot, "M2_Katki3TartimOk");
            _prevKatki4TartimOk = GetBitValue(snapshot, "M2_Katki4TartimOk");
            _prevKatki1SuTartimOk = GetBitValue(snapshot, "M2_Katki1SuTartimOk");
            _prevKatki2SuTartimOk = GetBitValue(snapshot, "M2_Katki2SuTartimOk");
            _prevKatki3SuTartimOk = GetBitValue(snapshot, "M2_Katki3SuTartimOk");
            _prevKatki4SuTartimOk = GetBitValue(snapshot, "M2_Katki4SuTartimOk");
        }

        /// <summary>
        /// Mixer pulse su sinyali kontrol√º - Veri kaydetme
        /// </summary>
        private async Task CheckMixerPulseSuSignal(PlcDataSnapshot snapshot)
        {
            var mixerPulseSu = GetBitValue(snapshot, "MixerdePulseSuVar");
            CurrentMixerPulseSu = mixerPulseSu;

            // Rising edge: Mixerdeki batch'lere pulse su verilerini kaydet
            if (mixerPulseSu && !_prevMixerPulseSu)
            {
                await RecordPulseWaterData(snapshot);
                OnFlowEvent?.Invoke("üíß Mixer pulse su - Pulse su verileri kaydedildi");
            }

            _prevMixerPulseSu = mixerPulseSu;
        }

        /// <summary>
        /// Har√ß hazƒ±r sinyali kontrol√º - Batch tamamlama
        /// </summary>
        private async Task CheckHarcHazirSignal(PlcDataSnapshot snapshot)
        {
            var harcHazir = GetBitValue(snapshot, "Har√ßHazƒ±r");
            CurrentHarcHazir = harcHazir;

            // Rising edge: Mixerdeki batch'leri tamamla
            if (harcHazir && !_prevHarcHazir)
            {
                await CompleteBatch(snapshot);
                OnFlowEvent?.Invoke("üéâ Har√ß hazƒ±r - Batch'ler tamamlandƒ±! Status: Tamamlandƒ±");
            }

            _prevHarcHazir = harcHazir;
        }

        /// <summary>
        /// Yeni batch olu≈ütur
        /// </summary>
        private async Task CreateNewBatch(PlcDataSnapshot snapshot, string operatorName)
        {
            try
            {
                var batch = new ConcreteBatch2
                {
                    OccurredAt = DateTime.UtcNow,
                    PlantCode = "MIXER2",
                    OperatorName = operatorName,
                    RecipeCode = "AUTO_RECIPE",
                    Status = "Yatay Kovada",
                    IsSimulated = false,
                    CreatedAt = DateTime.UtcNow,
                    RawPayloadJson = System.Text.Json.JsonSerializer.Serialize(snapshot)
                };

                // Aktif agregalarƒ± kaydet
                await RecordAggregateData(batch, snapshot);

                _context.ConcreteBatch2s.Add(batch);
                await _context.SaveChangesAsync();

                OnFlowEvent?.Invoke($"‚úÖ Yeni Mixer2 batch olu≈üturuldu (ID: {batch.Id}) - Status: Yatay Kovada");
            }
            catch (Exception ex)
            {
                OnFlowEvent?.Invoke($"‚ùå Mixer2 batch olu≈üturma hatasƒ±: {ex.Message}");
            }
        }

        /// <summary>
        /// Agrega verilerini kaydet
        /// </summary>
        private async Task RecordAggregateData(ConcreteBatch2 batch, PlcDataSnapshot snapshot)
        {
            // Aktif bitlerinde olasƒ± mapping sapmalarƒ±nƒ± bertaraf etmek i√ßin KG deƒüerine g√∂re kayƒ±t yap
            // E≈üik: 0.1 kg √ºzeri deƒüerleri ger√ßek kabul et
            var totalKg = 0.0;
            var aggregateCount = 0;
            
            // üîç DEBUG: T√ºm agrega deƒüerlerini logla
            var debugInfo = "üîç Agrega Debug:\n";
            for (int i = 1; i <= 8; i++)
            {
                var kg = GetWordValue(snapshot, $"M2_Agrega{i}Kg");
                debugInfo += $"Agrega{i}: {kg:F2}kg ";
                
                if (kg > 0.1)
                {
                    var aggregate = new ConcreteBatch2Aggregate
                    {
                        Slot = (short)i,
                        Name = $"Agrega{i}",
                        WeightKg = kg
                    };
                    batch.Aggregates.Add(aggregate);
                    totalKg += kg;
                    aggregateCount++;
                }
            }
            
            // Toplam agrega miktarƒ±nƒ± kaydet
            batch.TotalAggregateKg = totalKg;
            
            // Debug log - Her zaman g√∂ster
            OnFlowEvent?.Invoke(debugInfo);
            OnFlowEvent?.Invoke($"ü™® Agrega kayƒ±t: {aggregateCount} adet, Toplam: {totalKg:F1}kg");
        }

        /// <summary>
        /// √áimento verilerini kaydet
        /// </summary>
        private async Task RecordCementData(PlcDataSnapshot snapshot)
        {
            // SADECE bekleyen batch'lere √ßimento verilerini ekle
            if (_waitingForCementBatchIds.Count == 0)
            {
                OnFlowEvent?.Invoke("üß± DEBUG: Bekleyen batch yok - √ßimento kayƒ±t atlandƒ±");
                return;
            }

            // Bekleyen batch'leri al
            using var context = new ProductionDbContext();
            var waitingBatches = await context.ConcreteBatch2s
                .Where(b => _waitingForCementBatchIds.Contains(b.Id))
                .Include(b => b.Cements)
                .ToListAsync();

            if (waitingBatches.Count == 0)
            {
                OnFlowEvent?.Invoke("üß± DEBUG: Bekleyen batch'ler bulunamadƒ± - √ßimento kayƒ±t atlandƒ±");
                return;
            }

            foreach (var batch in waitingBatches)
            {
                OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batch.Id} i√ßin √ßimento kayƒ±t i≈ülemi ba≈ülatƒ±lƒ±yor");
                
                for (int i = 1; i <= 3; i++)
                {
                    var aktif = GetBitValue(snapshot, $"M2_Cimento{i}Aktif");
                    var tartimOk = GetBitValue(snapshot, $"M2_Cimento{i}TartimOk");
                    var kg = GetWordValue(snapshot, $"M2_Cimento{i}Kg");
                    
                    if (aktif && tartimOk && kg > 0)
                    {
                        // Batch'de zaten bu slot'ta √ßimento var mƒ± kontrol et
                        var existingCement = batch.Cements.FirstOrDefault(c => c.Slot == i);
                        if (existingCement != null)
                        {
                            OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batch.Id} i√ßin √áimento{i} zaten kayƒ±tlƒ± ({existingCement.WeightKg}kg) - tekrar kayƒ±t atlandƒ±");
                            continue;
                        }
                        
                        var cement = new ConcreteBatch2Cement
                        {
                            Slot = (short)i,
                            CementType = i switch
                            {
                                1 => "Standard",  // √áimento1 -> Standard
                                2 => "Beyaz",     // √áimento2 -> Beyaz
                                3 => "Siyah",     // √áimento3 -> Siyah
                                _ => $"Cimento{i}"
                            },
                            WeightKg = kg
                        };
                        batch.Cements.Add(cement);
                        batch.TotalCementKg += kg;
                        
                        OnFlowEvent?.Invoke($"üß± DEBUG: √áimento{i} kaydedildi: {kg}kg (Batch {batch.Id})");
                    }
                    else if (aktif && tartimOk && kg == 0)
                    {
                        OnFlowEvent?.Invoke($"üß± DEBUG: √áimento{i} aktif ve tartƒ±m OK ama kg=0 - kayƒ±t atlandƒ±");
                    }
                }
                
                // Batch'i veritabanƒ±na kaydet
                await context.SaveChangesAsync();
                
                // Silo g√ºncellemesi
                try
                {
                    var consumptionService = new CementConsumptionService(context);
                    await consumptionService.RecordMixer2ConsumptionAsync(batch);
                    OnFlowEvent?.Invoke($"üß± DEBUG: Batch {batch.Id} i√ßin silo g√ºncelleme tamamlandƒ±");
                }
                catch (Exception ex)
                {
                    OnFlowEvent?.Invoke($"üß± DEBUG: Silo g√ºncelleme hatasƒ±: {ex.Message}");
                }
            }
        }

        /// <summary>
        /// Katkƒ± verilerini kaydet - Tek seferde t√ºm aktif katkƒ±larƒ± kaydet
        /// </summary>
        private async Task RecordAdmixtureData(PlcDataSnapshot snapshot)
        {
            // SADECE bekleyen batch'lere katkƒ± verilerini ekle
            if (_waitingForAdmixtureBatchIds.Count == 0)
            {
                OnFlowEvent?.Invoke("üß™ DEBUG: Bekleyen batch yok - katkƒ± kayƒ±t atlandƒ±");
                return;
            }

            // Bekleyen batch'leri al
            using var context = new ProductionDbContext();
            var waitingBatches = await context.ConcreteBatch2s
                .Where(b => _waitingForAdmixtureBatchIds.Contains(b.Id))
                .Include(b => b.Admixtures)
                .ToListAsync();

            if (waitingBatches.Count == 0)
            {
                OnFlowEvent?.Invoke("üß™ DEBUG: Bekleyen batch'ler bulunamadƒ± - katkƒ± kayƒ±t atlandƒ±");
                return;
            }

            foreach (var mixerBatch in waitingBatches)
            {
                OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {mixerBatch.Id} i√ßin katkƒ± kayƒ±t i≈ülemi ba≈ülatƒ±lƒ±yor");

            // Katkƒ± grup aktif kontrol√º
            var katkiGrupAktif = GetBitValue(snapshot, "M2_KatkiGrupAktif");
            if (!katkiGrupAktif) 
            {
                OnFlowEvent?.Invoke("üß™ DEBUG: Katkƒ± grup aktif deƒüil - katkƒ± kayƒ±t atlandƒ±");
                return;
            }

            // Katkƒ± alias'larƒ±nƒ± y√ºkle
            var admixtureAliases = await _context.Admixture2Aliases
                .Where(a => a.IsActive)
                .ToDictionaryAsync(a => a.Slot, a => a.Name);

            // T√ºm aktif katkƒ±larƒ± topla
            var activeAdmixtures = new List<(int Slot, string Name, double ChemicalKg, double SuKg)>();

            for (int i = 1; i <= 4; i++)
            {
                // Katkƒ± aktif mi?
                var aktif = GetBitValue(snapshot, $"M2_Katki{i}Aktif");
                OnFlowEvent?.Invoke($"üß™ DEBUG: Katkƒ±{i} aktif: {aktif}");
                if (!aktif) continue;

                // Hem kimyasal hem su tartƒ±m OK gerekli
                var tartimOk = GetBitValue(snapshot, $"M2_Katki{i}TartimOk");
                var suTartimOk = GetBitValue(snapshot, $"M2_Katki{i}SuTartimOk");
                OnFlowEvent?.Invoke($"üß™ DEBUG: Katkƒ±{i} tartƒ±m OK: {tartimOk}, Su tartƒ±m OK: {suTartimOk}");

                // Her ikisi de tartƒ±m OK olmalƒ±
                if (!tartimOk || !suTartimOk) 
                {
                    OnFlowEvent?.Invoke($"üß™ DEBUG: Katkƒ±{i} tartƒ±m OK deƒüil - atlandƒ±");
                    continue;
                }

                var kimyasalKg = GetWordValue(snapshot, $"M2_Katki{i}KimyasalKg") / 10.0;
                var suKg = GetWordValue(snapshot, $"M2_Katki{i}SuKg") / 10.0;
                var totalKg = kimyasalKg + suKg;
                OnFlowEvent?.Invoke($"üß™ DEBUG: Katkƒ±{i} miktarlarƒ± - Kimyasal: {kimyasalKg}kg, Su: {suKg}kg, Toplam: {totalKg}kg");
                
                // E≈üik kontrol√º
                if (totalKg <= 0.1) 
                {
                    OnFlowEvent?.Invoke($"üß™ DEBUG: Katkƒ±{i} miktar √ßok az ({totalKg}kg) - atlandƒ±");
                    continue;
                }
                
                // Batch'de zaten bu slot'ta katkƒ± var mƒ± kontrol et
                var existingAdmixture = mixerBatch.Admixtures.FirstOrDefault(a => a.Slot == i);
                if (existingAdmixture != null)
                {
                    OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {mixerBatch.Id} i√ßin Katkƒ±{i} zaten kayƒ±tlƒ± ({existingAdmixture.ChemicalKg + existingAdmixture.WaterKg}kg) - tekrar kayƒ±t atlandƒ±");
                    continue;
                }
                
                // Alias ismi kullan
                var displayName = admixtureAliases.TryGetValue((short)i, out var aliasName) && !string.IsNullOrWhiteSpace(aliasName)
                    ? aliasName
                    : $"Katki{i}";

                OnFlowEvent?.Invoke($"üß™ DEBUG: Katkƒ±{i} kaydedilecek - ƒ∞sim: {displayName}");
                activeAdmixtures.Add((i, displayName, kimyasalKg, suKg));
            }

            // Eƒüer aktif katkƒ± varsa, hepsini tek seferde kaydet
            OnFlowEvent?.Invoke($"üß™ DEBUG: Toplam aktif katkƒ± sayƒ±sƒ±: {activeAdmixtures.Count}");
            if (activeAdmixtures.Count > 0)
            {
                foreach (var (slot, name, chemicalKg, suKg) in activeAdmixtures)
                {
                    var admixture = new ConcreteBatch2Admixture
                    {
                        Slot = (short)slot,
                        Name = name,
                        ChemicalKg = chemicalKg,
                        WaterKg = suKg
                    };
                    mixerBatch.Admixtures.Add(admixture);
                    mixerBatch.TotalAdmixtureKg += (chemicalKg + suKg);
                }

                await context.SaveChangesAsync();

                var totalChemical = activeAdmixtures.Sum(a => a.ChemicalKg);
                var totalWater = activeAdmixtures.Sum(a => a.SuKg);
                var totalTotal = totalChemical + totalWater;

                OnFlowEvent?.Invoke($"üß™ Katkƒ± kayƒ±t tamamlandƒ±: {activeAdmixtures.Count} katkƒ±, Kimyasal={totalChemical}kg, Su={totalWater}kg, Toplam={totalTotal}kg (Batch {mixerBatch.Id})");
            }
            else
            {
                OnFlowEvent?.Invoke("üß™ DEBUG: Hi√ß aktif katkƒ± bulunamadƒ± - kayƒ±t yapƒ±lmadƒ±");
            }
            
            // Kayƒ±t yapƒ±lan batch'leri bekleyen listesinden √ßƒ±kar
            var recordedBatchIds = _waitingForAdmixtureBatchIds.ToList();
            foreach (var batchId in recordedBatchIds)
            {
                _waitingForAdmixtureBatchIds.Remove(batchId);
                _admixtureRecordedBatchIds.Add(batchId);
                _admixtureRecordTimes[batchId] = DateTime.Now;
                OnFlowEvent?.Invoke($"üß™ DEBUG: Batch {batchId} katkƒ± kayƒ±t edilen listeye eklendi");
            }
            OnFlowEvent?.Invoke($"üß™ DEBUG: Katkƒ± kaydedildi - kayƒ±t yapƒ±lan batch'ler bekleyen listesinden √ßƒ±karƒ±ldƒ±. Kayƒ±t edilen batch sayƒ±sƒ±: {_admixtureRecordedBatchIds.Count}");
            }
        }

        /// <summary>
        /// Loadcell su verilerini kaydet
        /// </summary>
        private async Task RecordLoadcellWaterData(PlcDataSnapshot snapshot)
        {
            // "Mixerde" status'taki t√ºm batch'lere loadcell su verilerini ekle
            var mixerBatches = await GetBatchesByStatus("Mixerde");
            if (mixerBatches.Count == 0) return;

            var kg = GetWordValue(snapshot, "M2_SuLoadcellKg");
            foreach (var batch in mixerBatches)
            {
                batch.LoadcellWaterKg = kg;
                batch.EffectiveWaterKg += kg;
            }

            await _context.SaveChangesAsync();
        }

        /// <summary>
        /// Pulse su verilerini kaydet
        /// </summary>
        private async Task RecordPulseWaterData(PlcDataSnapshot snapshot)
        {
            // "Mixerde" status'taki t√ºm batch'lere pulse su verilerini ekle
            var mixerBatches = await GetBatchesByStatus("Mixerde");
            if (mixerBatches.Count == 0) return;

            var kg = GetWordValue(snapshot, "M2_SuPulseKg");
            foreach (var batch in mixerBatches)
            {
                batch.PulseWaterKg = kg;
                batch.EffectiveWaterKg += kg;
            }

            await _context.SaveChangesAsync();
        }

        /// <summary>
        /// Batch'i tamamla
        /// </summary>
        private async Task CompleteBatch(PlcDataSnapshot snapshot)
        {
            // "Mixerde" status'taki t√ºm batch'leri tamamla
            var mixerBatches = await GetBatchesByStatus("Mixerde");
            if (mixerBatches.Count == 0) return;

            foreach (var batch in mixerBatches)
            {
                // Status'u tamamlandƒ± yap
                batch.Status = "Tamamlandƒ±";
                batch.CompletedAt = DateTime.UtcNow;

                // Nem oranƒ±nƒ± hesapla
                if (batch.TotalCementKg > 0)
                {
                    batch.WaterCementRatio = batch.EffectiveWaterKg / batch.TotalCementKg;
                    batch.MoisturePercent = (batch.EffectiveWaterKg / (batch.TotalCementKg + batch.TotalAggregateKg)) * 100;
                }
            }

            await _context.SaveChangesAsync();
            OnFlowEvent?.Invoke($"üéâ {mixerBatches.Count} Mixer2 batch tamamlandƒ± - Status: Tamamlandƒ±");
        }

        /// <summary>
        /// Belirli status'taki batch'leri getir (√ßoklu batch sistemi)
        /// </summary>
        private async Task<List<ConcreteBatch2>> GetBatchesByStatus(string status)
        {
            return await _context.ConcreteBatch2s
                .Where(b => b.PlantCode == "MIXER2" && b.Status == status)
                .OrderByDescending(b => b.OccurredAt)
                .ToListAsync();
        }

        /// <summary>
        /// Belirli status'taki tek batch'i getir (tek batch sistemi)
        /// </summary>
        private async Task<ConcreteBatch2?> GetSingleBatchByStatus(string status)
        {
            return await _context.ConcreteBatch2s
                .Where(b => b.PlantCode == "MIXER2" && b.Status == status)
                .OrderByDescending(b => b.OccurredAt)
                .FirstOrDefaultAsync();
        }

        /// <summary>
        /// Batch status'unu g√ºncelle
        /// </summary>
        private async Task UpdateBatchStatus(string currentStatus, string newStatus)
        {
            // Belirli status'taki t√ºm batch'leri yeni status'a g√ºncelle
            var batches = await GetBatchesByStatus(currentStatus);
            if (batches.Count == 0) return;

            foreach (var batch in batches)
            {
                batch.Status = newStatus;
            }
            await _context.SaveChangesAsync();
        }

        /// <summary>
        /// Bit deƒüerini oku
        /// </summary>
        private bool GetBitValue(PlcDataSnapshot snapshot, string registerName)
        {
            return registerName switch
            {
                "YatayKovadaMalzemeVar" => snapshot.HorizontalHasMaterial,
                "DikeyKovadaMalzemeVar" => snapshot.VerticalHasMaterial,
                "BeklemeBunkerindeMalzemeVar" => snapshot.WaitingBunkerHasMaterial,
                "MixerdeAggregaVar" => snapshot.MixerHasAggregate,
                "MixerdeCimentoVar" => snapshot.MixerHasCement,
                "MixerdeLoadcellSuVar" => snapshot.MixerHasWaterLoadcell,
                "MixerdeKatkiVar" => snapshot.MixerHasAdmixture,
                "MixerdePulseSuVar" => snapshot.MixerHasWaterPulse,
                "Har√ßHazƒ±r" => snapshot.BatchReadySignal,
                "M2_Agrega1Aktif" => snapshot.Aggregate1Active,
                "M2_Agrega2Aktif" => snapshot.Aggregate2Active,
                "M2_Agrega3Aktif" => snapshot.Aggregate3Active,
                "M2_Agrega4Aktif" => snapshot.Aggregate4Active,
                "M2_Agrega5Aktif" => snapshot.Aggregate5Active,
                "M2_Agrega6Aktif" => snapshot.Aggregate6Active,
                "M2_Agrega7Aktif" => snapshot.Aggregate7Active,
                "M2_Agrega8Aktif" => snapshot.Aggregate8Active,
                "M2_Cimento1Aktif" => snapshot.Cement1Active,
                "M2_Cimento1TartimOk" => snapshot.Cement1TartimOk,
                "M2_Cimento2Aktif" => snapshot.Cement2Active,
                "M2_Cimento2TartimOk" => snapshot.Cement2TartimOk,
                "M2_Cimento3Aktif" => snapshot.Cement3Active,
                "M2_Cimento3TartimOk" => snapshot.Cement3TartimOk,
                "M2_Katki1Aktif" => snapshot.Admixture1Active,
                "M2_Katki2Aktif" => snapshot.Admixture2Active,
                "M2_Katki3Aktif" => snapshot.Admixture3Active,
                "M2_Katki4Aktif" => snapshot.Admixture4Active,
                "M2_KatkiGrupAktif" => snapshot.AdmixtureGroupActive,
                "M2_Katki1TartimOk" => snapshot.Admixture1TartimOk,
                "M2_Katki1SuTartimOk" => snapshot.Admixture1WaterTartimOk,
                "M2_Katki2TartimOk" => snapshot.Admixture2TartimOk,
                "M2_Katki2SuTartimOk" => snapshot.Admixture2WaterTartimOk,
                "M2_Katki3TartimOk" => snapshot.Admixture3TartimOk,
                "M2_Katki3SuTartimOk" => snapshot.Admixture3WaterTartimOk,
                "M2_Katki4TartimOk" => snapshot.Admixture4TartimOk,
                "M2_Katki4SuTartimOk" => snapshot.Admixture4WaterTartimOk,
                "H31.2" => snapshot.PigmentGroupActive,
                "H31.10" => snapshot.Pigment1Active,
                "H31.3" => snapshot.Pigment1TartimOk,
                "H32.10" => snapshot.Pigment2Active,
                "H32.3" => snapshot.Pigment2TartimOk,
                "H33.10" => snapshot.Pigment3Active,
                "H33.3" => snapshot.Pigment3TartimOk,
                "H34.10" => snapshot.Pigment4Active,
                "H34.3" => snapshot.Pigment4TartimOk,
                _ => false
            };
        }

        /// <summary>
        /// Word deƒüerini oku
        /// </summary>
        private double GetWordValue(PlcDataSnapshot snapshot, string registerName)
        {
            return registerName switch
            {
                "M2_Agrega1Kg" => snapshot.Aggregate1Amount,
                "M2_Agrega2Kg" => snapshot.Aggregate2Amount,
                "M2_Agrega3Kg" => snapshot.Aggregate3Amount,
                "M2_Agrega4Kg" => snapshot.Aggregate4Amount,
                "M2_Agrega5Kg" => snapshot.Aggregate5Amount,
                "M2_Agrega6Kg" => snapshot.Aggregate6Amount,
                "M2_Agrega7Kg" => snapshot.Aggregate7Amount,
                "M2_Agrega8Kg" => snapshot.Aggregate8Amount,
                "M2_Cimento1Kg" => snapshot.Cement1Amount,
                "M2_Cimento2Kg" => snapshot.Cement2Amount,
                "M2_Cimento3Kg" => snapshot.Cement3Amount,
                "M2_SuLoadcellKg" => snapshot.Water1Amount,
                "M2_SuPulseKg" => snapshot.Water2Amount,
                "M2_Katki1KimyasalKg" => snapshot.Admixture1ChemicalAmount,
                "M2_Katki1SuKg" => snapshot.Admixture1WaterAmount,
                "M2_Katki2KimyasalKg" => snapshot.Admixture2ChemicalAmount,
                "M2_Katki2SuKg" => snapshot.Admixture2WaterAmount,
                "M2_Katki3KimyasalKg" => snapshot.Admixture3ChemicalAmount,
                "M2_Katki3SuKg" => snapshot.Admixture3WaterAmount,
                "M2_Katki4KimyasalKg" => snapshot.Admixture4ChemicalAmount,
                "M2_Katki4SuKg" => snapshot.Admixture4WaterAmount,
                "DM308" => snapshot.Pigment1Amount,
                "DM310" => snapshot.Pigment2Amount,
                "DM312" => snapshot.Pigment3Amount,
                "DM314" => snapshot.Pigment4Amount,
                _ => 0
            };
        }

        /// <summary>
        /// Mixer pigment sinyali kontrol√º - Pigment verilerini kaydet
        /// </summary>
        private async Task CheckMixerPigmentSignal(PlcDataSnapshot snapshot)
        {
            // Pigment register g√ºncelleme kaldƒ±rƒ±ldƒ± - sadece katkƒ± sinyalleri g√∂sterilecek
            
            // Debug: T√ºm status'lardaki batch'leri kontrol et
            var yatayKovaBatches = await GetBatchesByStatus("Yatay Kovada");
            var dikeyKovaBatches = await GetBatchesByStatus("Dikey Kovada");
            var beklemeBatches = await GetBatchesByStatus("Bekleme Bunkerinde");
            var mixerBatches = await GetBatchesByStatus("Mixerde");
            
            OnFlowEvent?.Invoke($"üîç Pigment Debug - Yatay: {yatayKovaBatches.Count}, Dikey: {dikeyKovaBatches.Count}, Bekleme: {beklemeBatches.Count}, Mixer: {mixerBatches.Count}");
            
            // Sadece "Yatay Kovada" status'taki batch'lere pigment ekle
            if (yatayKovaBatches.Count == 0) 
            {
                OnFlowEvent?.Invoke($"üé® Pigment kayƒ±t atlandƒ± - Yatay Kovada batch yok");
                return;
            }

            // Her batch i√ßin pigment verilerini kaydet
            foreach (var batch in yatayKovaBatches)
            {
                await RecordPigmentData(batch, snapshot);
            }
        }

        // UpdatePigmentRegisterDisplay fonksiyonu kaldƒ±rƒ±ldƒ± - pigment sinyalleri artƒ±k g√∂sterilmiyor

        /// <summary>
        /// Pigment verilerini kaydet - Basitle≈ütirilmi≈ü mantƒ±k
        /// Sadece "yatay kovada" status'ta ve pigment grubu aktifse kaydet
        /// </summary>
        private async Task RecordPigmentData(ConcreteBatch2 batch, PlcDataSnapshot snapshot)
        {
            // üîç DEBUG: Pigment debug bilgisi
            var pigmentGrupAktif = GetBitValue(snapshot, "H31.2");
            OnFlowEvent?.Invoke($"üé® Pigment Debug - Batch Status: {batch.Status}, Grup Aktif: {pigmentGrupAktif}");
            
            // 1. ≈ûart: Batch status'u "yatay kovada" olmalƒ±
            if (batch.Status != "Yatay Kovada")
            {
                OnFlowEvent?.Invoke($"üé® Pigment kayƒ±t atlandƒ± - Status: {batch.Status} (Yatay Kovada olmalƒ±)");
                return; // Sadece yatay kovada iken pigment kaydet
            }

            // 2. ≈ûart: Pigment grubu aktif mi kontrol et
            if (!pigmentGrupAktif)
            {
                OnFlowEvent?.Invoke($"üé® Pigment kayƒ±t atlandƒ± - Grup aktif deƒüil");
                return; // Pigment grubu aktif deƒüilse hi√ßbir ≈üey yapma
            }

            // Pigment alias'larƒ±nƒ± y√ºkle
            var pigmentAliases = await _context.Pigment2Aliases
                .Where(a => a.IsActive)
                .ToDictionaryAsync(a => a.Slot, a => a.Name);

            // 3. ≈ûart: Aktif pigment var mƒ± + Tartƒ±m OK sinyali geldi mi?
            // Pigment1 kontrol√º
            var pigment1Aktif = GetBitValue(snapshot, "H31.10");
            var pigment1TartimOk = GetBitValue(snapshot, "H31.3");
            var pigment1Kg = GetWordValue(snapshot, "DM308");
            
            OnFlowEvent?.Invoke($"üé® Pigment1: Aktif={pigment1Aktif}, TartimOk={pigment1TartimOk}, RawKg={pigment1Kg:F2}, AfterDiv100={pigment1Kg/100.0:F2}");
            
            if (pigment1Aktif && pigment1TartimOk) // Edge detection kaldƒ±rƒ±ldƒ±
            {
                var kg = GetWordValue(snapshot, "DM308");
                if (kg > 0.1) // E≈üik kontrol√º
                {
                    batch.Pigment1Kg = kg / 100.0; // KG deƒüerini 100.0 ile b√∂l
                    // TotalPigmentKg'yi yeniden hesapla (toplam yerine)
                    batch.TotalPigmentKg = batch.Pigment1Kg + batch.Pigment2Kg + batch.Pigment3Kg + batch.Pigment4Kg;
                    
                    // Alias ismi kullan
                    var displayName = pigmentAliases.TryGetValue(1, out var aliasName) && !string.IsNullOrWhiteSpace(aliasName)
                        ? aliasName
                        : "Pigment1";
                    
                    OnFlowEvent?.Invoke($"üé® {displayName} kaydedildi: {batch.Pigment1Kg:F2}kg (Batch {batch.Id})");
                }
            }

            // Pigment2 kontrol√º
            var pigment2Aktif = GetBitValue(snapshot, "H32.10");
            var pigment2TartimOk = GetBitValue(snapshot, "H32.3");
            var pigment2Kg = GetWordValue(snapshot, "DM310");
            
            OnFlowEvent?.Invoke($"üé® Pigment2: Aktif={pigment2Aktif}, TartimOk={pigment2TartimOk}, RawKg={pigment2Kg:F2}, AfterDiv100={pigment2Kg/100.0:F2}");
            
            if (pigment2Aktif && pigment2TartimOk) // Edge detection kaldƒ±rƒ±ldƒ±
            {
                var kg = GetWordValue(snapshot, "DM310");
                if (kg > 0.1) // E≈üik kontrol√º
                {
                    batch.Pigment2Kg = kg / 100.0; // KG deƒüerini 100.0 ile b√∂l
                    // TotalPigmentKg'yi yeniden hesapla (toplam yerine)
                    batch.TotalPigmentKg = batch.Pigment1Kg + batch.Pigment2Kg + batch.Pigment3Kg + batch.Pigment4Kg;
                    
                    // Alias ismi kullan
                    var displayName = pigmentAliases.TryGetValue(2, out var aliasName) && !string.IsNullOrWhiteSpace(aliasName)
                        ? aliasName
                        : "Pigment2";
                    
                    OnFlowEvent?.Invoke($"üé® {displayName} kaydedildi: {batch.Pigment2Kg:F2}kg (Batch {batch.Id})");
                }
            }

            // Pigment3 kontrol√º
            var pigment3Aktif = GetBitValue(snapshot, "H33.10");
            var pigment3TartimOk = GetBitValue(snapshot, "H33.3");
            var pigment3Kg = GetWordValue(snapshot, "DM312");
            
            OnFlowEvent?.Invoke($"üé® Pigment3: Aktif={pigment3Aktif}, TartimOk={pigment3TartimOk}, RawKg={pigment3Kg:F2}, AfterDiv100={pigment3Kg/100.0:F2}");
            
            if (pigment3Aktif && pigment3TartimOk) // Edge detection kaldƒ±rƒ±ldƒ±
            {
                var kg = GetWordValue(snapshot, "DM312");
                if (kg > 0.1) // E≈üik kontrol√º
                {
                    batch.Pigment3Kg = kg / 100.0; // KG deƒüerini 100.0 ile b√∂l
                    // TotalPigmentKg'yi yeniden hesapla (toplam yerine)
                    batch.TotalPigmentKg = batch.Pigment1Kg + batch.Pigment2Kg + batch.Pigment3Kg + batch.Pigment4Kg;
                    
                    // Alias ismi kullan
                    var displayName = pigmentAliases.TryGetValue(3, out var aliasName) && !string.IsNullOrWhiteSpace(aliasName)
                        ? aliasName
                        : "Pigment3";
                    
                    OnFlowEvent?.Invoke($"üé® {displayName} kaydedildi: {batch.Pigment3Kg:F2}kg (Batch {batch.Id})");
                }
            }

            // Pigment4 kontrol√º
            var pigment4Aktif = GetBitValue(snapshot, "H34.10");
            var pigment4TartimOk = GetBitValue(snapshot, "H34.3");
            var pigment4Kg = GetWordValue(snapshot, "DM314");
            
            OnFlowEvent?.Invoke($"üé® Pigment4: Aktif={pigment4Aktif}, TartimOk={pigment4TartimOk}, RawKg={pigment4Kg:F2}, AfterDiv100={pigment4Kg/100.0:F2}");
            
            if (pigment4Aktif && pigment4TartimOk) // Edge detection kaldƒ±rƒ±ldƒ±
            {
                var kg = GetWordValue(snapshot, "DM314");
                if (kg > 0.1) // E≈üik kontrol√º
                {
                    batch.Pigment4Kg = kg / 100.0; // KG deƒüerini 100.0 ile b√∂l
                    // TotalPigmentKg'yi yeniden hesapla (toplam yerine)
                    batch.TotalPigmentKg = batch.Pigment1Kg + batch.Pigment2Kg + batch.Pigment3Kg + batch.Pigment4Kg;
                    
                    // Alias ismi kullan
                    var displayName = pigmentAliases.TryGetValue(4, out var aliasName) && !string.IsNullOrWhiteSpace(aliasName)
                        ? aliasName
                        : "Pigment4";
                    
                    OnFlowEvent?.Invoke($"üé® {displayName} kaydedildi: {batch.Pigment4Kg:F2}kg (Batch {batch.Id})");
                }
            }

            // Deƒüi≈üiklik varsa kaydet
            if (batch.Pigment1Kg > 0 || batch.Pigment2Kg > 0 || batch.Pigment3Kg > 0 || batch.Pigment4Kg > 0)
            {
                await _context.SaveChangesAsync();
            }
        }
    }
}
